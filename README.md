| Supported Targets | TC375 Litekit |
| ----------------- | ----- |

# aurix_tc375_inav
This code implements a ported version of [inav](https://github.com/jakobgif/inav_tc375.git) for the [Aurix TC375 Litekit](https://www.infineon.com/cms/de/product/evaluation-boards/kit_a2g_tc375_lite/). 

Run `git clone --recurse-submodules "https://github.com/jakobgif/aurix_tc375_inav.git"` to clone the repo including the submodules.

## Table of contents
- [aurix\_tc375\_inav](#aurix_tc375_inav)
  - [Table of contents](#table-of-contents)
  - [Building](#building)
    - [Build Macros](#build-macros)
    - [Build options](#build-options)
      - [Release build](#release-build)
      - [Debug build](#debug-build)
    - [Linker Script](#linker-script)
  - [Submodules](#submodules)
  - [VSCode](#vscode)
  - [Scripts](#scripts)
  
## Building
Currently the build process is performed inside of Aurix development studio. This project has two build configurations; Debug and Release.

### Build Macros
The required macros are documented in the inav readme.
- `TC375` to build for aurix tc375
- `__TARGET__=\"TC375\"` name of the target CPU
- Version string macros are generated by [create_version_strings.sh](create_version_strings.sh) and stored in a header file.
- `__TRICORE__` is defined for some aurix cpu specific build options (such as replacing arm math)

### Build options
Do **not** use the Tasking compiler. For building the dialect flag `-std=gnu11` is set.

#### Release build
- Use TriCore Release (GCC) configuration
- `BUILD_CONFIG_RELEASE` is defined via -D flag
- Release uses optimisation level `Optimize more (-O2)`

#### Debug build
- Use TriCore Debug (GCC) configuration
- `BUILD_CONFIG_DEBUG` is defined via -D flag
- Debug uses optimisation level `Optimize for debug (-Og)`

### Linker Script
Multiple section were added to the linker script:
```
CORE_ID = GLOBAL;
    SECTIONS
    {
        .busdev_registry :
        {
            PROVIDE_HIDDEN (__busdev_registry_start = .);
            KEEP (*(.busdev_registry))
            KEEP (*(SORT(.busdev_registry.*)))
            PROVIDE_HIDDEN (__busdev_registry_end = .);
        } > default_rom
        
        .pg_registry :
        {
            PROVIDE_HIDDEN (__pg_registry_start = .);
            KEEP (*(.pg_registry))
            KEEP (*(SORT(.pg_registry.*)))
            PROVIDE_HIDDEN (__pg_registry_end = .);
        } > default_rom
    
        .pg_resetdata :
        {
            PROVIDE_HIDDEN (__pg_resetdata_start = .);
            KEEP (*(.pg_resetdata))
            PROVIDE_HIDDEN (__pg_resetdata_end = .);
        } > default_rom
    }
```

## Submodules
This project uses a ported version of the inav flight control software as a submodule.

The submodules are also listed in [.gitmodules](.gitmodules).

Please refer to the [inav readme](inav_tc375\readme.md) for more infos.

## VSCode 
If vscode is used the following `c_cpp_properties.json` can be used to configure the workspace.

```JSON
{
    "configurations": [
        {
            "name": "Aurix",
            "includePath": [
                "${workspaceFolder}/*",
                "${workspaceFolder}/Libraries/**", //aurix lib
                "${workspaceFolder}/configurations/**",
                //inav lib all
                //"${workspaceFolder}/inav_tc375/src/main/**",
                //inav lib with specific target
                "${workspaceFolder}/inav_tc375/src/main/*",
                "${workspaceFolder}/inav_tc375/src/main/blackbox/**",
                "${workspaceFolder}/inav_tc375/src/main/build/**",
                "${workspaceFolder}/inav_tc375/src/main/cms/**",
                "${workspaceFolder}/inav_tc375/src/main/common/**",
                "${workspaceFolder}/inav_tc375/src/main/config/**",
                "${workspaceFolder}/inav_tc375/src/main/drivers/**",
                "${workspaceFolder}/inav_tc375/src/main/fc/**",
                "${workspaceFolder}/inav_tc375/src/main/flight/**",
                "${workspaceFolder}/inav_tc375/src/main/io/**",
                "${workspaceFolder}/inav_tc375/src/main/msc/**",
                "${workspaceFolder}/inav_tc375/src/main/msp/**",
                "${workspaceFolder}/inav_tc375/src/main/navigation/**",
                "${workspaceFolder}/inav_tc375/src/main/programming/**",
                "${workspaceFolder}/inav_tc375/src/main/rx/**",
                "${workspaceFolder}/inav_tc375/src/main/scheduler/**",
                "${workspaceFolder}/inav_tc375/src/main/sensors/**",
                "${workspaceFolder}/inav_tc375/src/main/startup/**",
                "${workspaceFolder}/inav_tc375/src/main/target/*",
                "${workspaceFolder}/inav_tc375/src/main/target/FHTW_TC375_LK/**", //only our target required
                "${workspaceFolder}/inav_tc375/src/main/telemetry/**"
            ],
            "defines": [
                "TC375",
                "__VERSION__=0",
                "__TRICORE__"
            ],
            "cStandard": "gnu99",
            "cppStandard": "gnu++17",
            "intelliSenseMode": "gcc-x64"
        }
    ],
    "version": 4
}
```

## Scripts
[pre_build.bat](pre_build.bat) must be run before building the code. The aurix project is configured to do that.

[create_version_strings.sh](create_version_strings.sh) generates a header file containing the version information. This includes current git hash and tag. This script is called by [pre_build.bat](pre_build.bat).

[generate_settings.bat](generate_settings.bat) is used to create the settings_generated.h and .c. These files must be regenerated each time the compile time platform configuration is modified. 